<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PluginResource.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pia</a> &gt; <a href="index.source.html" class="el_package">eu.ownyourdata.pia.web.rest</a> &gt; <span class="el_source">PluginResource.java</span></div><h1>PluginResource.java</h1><pre class="source lang-java linenums">package eu.ownyourdata.pia.web.rest;

import com.codahale.metrics.annotation.Timed;
import eu.ownyourdata.pia.domain.InvalidManifestException;
import eu.ownyourdata.pia.domain.plugin.Manifest;
import eu.ownyourdata.pia.domain.plugin.Plugin;
import eu.ownyourdata.pia.domain.plugin.RequirementManifestException;
import eu.ownyourdata.pia.domain.plugin.StandalonePlugin;
import eu.ownyourdata.pia.domain.sam.Store;
import eu.ownyourdata.pia.repository.*;
import eu.ownyourdata.pia.web.rest.dto.PluginDTO;
import eu.ownyourdata.pia.web.rest.dto.PluginSecret;
import eu.ownyourdata.pia.web.rest.mapper.PluginMapper;
import eu.ownyourdata.pia.web.rest.util.HeaderUtil;
import eu.ownyourdata.pia.web.rest.util.PaginationUtil;
import eu.ownyourdata.pia.web.utils.Files;
import org.apache.commons.io.FileUtils;
import org.json.JSONException;
import org.json.JSONObject;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.security.oauth2.provider.ClientDetails;
import org.springframework.security.oauth2.provider.ClientDetailsService;
import org.springframework.security.oauth2.provider.ClientRegistrationException;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.multipart.MultipartFile;

import javax.inject.Inject;
import javax.validation.Valid;
import java.io.File;
import java.io.IOException;
import java.net.URISyntaxException;
import java.net.URL;
import java.util.Base64;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;
import java.util.zip.ZipFile;

/**
 * REST controller for managing Plugin.
 */
@RestController
@RequestMapping(&quot;/api&quot;)
<span class="fc" id="L52">public class PluginResource {</span>

<span class="fc" id="L54">    private final Logger log = LoggerFactory.getLogger(PluginResource.class);</span>

    @Inject
    private PluginMapper pluginMapper;

    @Inject
    private PluginRepository pluginRepository;

    @Inject
    private StoreRepository storeRepository;

    @Inject
    private ProcessRepository processRepository;

    @Inject
    private ClientDetailsService clientDetailsService;

<span class="fc" id="L71">    private RestTemplate restTemplate = new RestTemplate();</span>

    /**
     * GET  /plugins -&gt; get all the plugins.
     */
    @RequestMapping(value = &quot;/plugins&quot;,
        method = RequestMethod.GET,
        produces = MediaType.APPLICATION_JSON_VALUE)
    @Timed
    public ResponseEntity&lt;List&lt;PluginDTO&gt;&gt; getAllPlugins(Pageable pageable) throws URISyntaxException {
<span class="nc" id="L81">        log.debug(&quot;REST request to get a page of Plugins&quot;);</span>
<span class="nc" id="L82">        Page&lt;Plugin&gt; page = pluginRepository.findAll(pageable);</span>

<span class="nc" id="L84">        List&lt;PluginDTO&gt; pluginDTOs = page.getContent().stream()</span>
<span class="nc" id="L85">            .map(plugin -&gt; pluginMapper.pluginToPluginDTO(plugin))</span>
<span class="nc" id="L86">            .collect(Collectors.toList());</span>


<span class="nc" id="L89">        HttpHeaders headers = PaginationUtil.generatePaginationHttpHeaders(page, &quot;/api/plugins&quot;);</span>
<span class="nc" id="L90">        return new ResponseEntity&lt;&gt;(pluginDTOs, headers, HttpStatus.OK);</span>
    }

    /**
     * GET  /plugins/:id -&gt; get the &quot;id&quot; plugin.
     */
    @RequestMapping(value = &quot;/plugins/{id}&quot;,
        method = RequestMethod.GET,
        produces = MediaType.APPLICATION_JSON_VALUE)
    @Timed
    public ResponseEntity&lt;PluginDTO&gt; getPlugin(@PathVariable Long id) {
<span class="nc" id="L101">        log.debug(&quot;REST request to get Plugin : {}&quot;, id);</span>
<span class="nc" id="L102">        Plugin plugin = pluginRepository.findOne(id);</span>
<span class="nc" id="L103">        return Optional.ofNullable(plugin)</span>
<span class="nc" id="L104">            .map(result -&gt; new ResponseEntity&lt;&gt;(</span>
<span class="nc" id="L105">                pluginMapper.pluginToPluginDTO(result),</span>
                HttpStatus.OK))
<span class="nc" id="L107">            .orElse(new ResponseEntity&lt;&gt;(HttpStatus.NOT_FOUND));</span>
    }

    /**
     * GET  /plugins/:id/start -&gt; start the &quot;id&quot; plugin.
     */
    @RequestMapping(value = &quot;/plugins/{id}/start&quot;,
        method = RequestMethod.GET,
        produces = MediaType.APPLICATION_JSON_VALUE)
    @Timed
    public ResponseEntity&lt;Void&gt; startPlugin(@PathVariable Long id) {
<span class="nc" id="L118">        log.debug(&quot;REST request to start Plugin : {}&quot;, id);</span>
<span class="nc" id="L119">        Plugin plugin = pluginRepository.findOne(id);</span>
        try {
<span class="nc" id="L121">            processRepository.create(((StandalonePlugin) plugin));</span>
<span class="nc" id="L122">            return ResponseEntity.status(HttpStatus.OK).build();</span>
<span class="nc" id="L123">        } catch (Exception e) {</span>
<span class="nc" id="L124">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();</span>
        }
    }

    /**
     * GET  /plugins/:id/stop -&gt; stop the &quot;id&quot; plugin.
     */
    @RequestMapping(value = &quot;/plugins/{id}/stop&quot;,
        method = RequestMethod.GET,
        produces = MediaType.APPLICATION_JSON_VALUE)
    @Timed
    public ResponseEntity&lt;Void&gt; stopPlugin(@PathVariable Long id) {
<span class="nc" id="L136">        log.debug(&quot;REST request to start Plugin : {}&quot;, id);</span>
<span class="nc" id="L137">        Plugin plugin = pluginRepository.findOne(id);</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">        if (processRepository.stop(((StandalonePlugin) plugin))) {</span>
<span class="nc" id="L139">            return ResponseEntity.status(HttpStatus.OK).build();</span>
        } else {
<span class="nc" id="L141">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();</span>
        }
    }

    /**
     * DELETE  /plugins/:id -&gt; delete the &quot;id&quot; plugin.
     */
    @RequestMapping(value = &quot;/plugins/{id}&quot;,
        method = RequestMethod.DELETE,
        produces = MediaType.APPLICATION_JSON_VALUE)
    @Timed
    public ResponseEntity&lt;Void&gt; deletePlugin(@PathVariable Long id) {
<span class="nc" id="L153">        log.debug(&quot;REST request to delete Plugin : {}&quot;, id);</span>
<span class="nc" id="L154">        Plugin plugin = pluginRepository.findOne(id);</span>

<span class="nc bnc" id="L156" title="All 2 branches missed.">        if (plugin != null) {</span>
            try {
<span class="nc" id="L158">                pluginRepository.deactivate(plugin);</span>
<span class="nc" id="L159">                pluginRepository.uninstall(plugin);</span>
<span class="nc" id="L160">                pluginRepository.delete(id);</span>
<span class="nc" id="L161">                return ResponseEntity.ok().headers(HeaderUtil.createEntityDeletionAlert(&quot;plugin&quot;, id.toString())).build();</span>
<span class="nc" id="L162">            } catch (IOException e) {</span>
<span class="nc" id="L163">                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();</span>
<span class="nc" id="L164">            } catch (Exception e) {</span>
<span class="nc" id="L165">                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();</span>
            }
        } else {
<span class="nc" id="L168">            return ResponseEntity.status(HttpStatus.NOT_FOUND).build();</span>
        }
    }


    /**
     * GET  /plugins/:id -&gt; get the &quot;id&quot; plugin.
     */
    @RequestMapping(value = &quot;/plugins/{id}/secret&quot;,
        method = RequestMethod.GET,
        produces = MediaType.APPLICATION_JSON_VALUE)
    @Timed
    public ResponseEntity&lt;PluginSecret&gt; getPluginSecret(@PathVariable Long id) {
<span class="nc" id="L181">        log.debug(&quot;REST request to get Plugin : {}&quot;, id);</span>
<span class="nc" id="L182">        Plugin plugin = pluginRepository.findOne(id);</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">        if (plugin == null) {</span>
<span class="nc" id="L184">            return new ResponseEntity&lt;&gt;(HttpStatus.NOT_FOUND);</span>
        } else {
            try {
<span class="nc" id="L187">                ClientDetails clientDetails = clientDetailsService.loadClientByClientId(plugin.getIdentifier());</span>

<span class="nc" id="L189">                return new ResponseEntity&lt;&gt;(new PluginSecret(clientDetails.getClientSecret()),HttpStatus.OK);</span>
<span class="nc" id="L190">            } catch (ClientRegistrationException e) {</span>
<span class="nc" id="L191">                return new ResponseEntity&lt;&gt;(HttpStatus.NOT_FOUND);</span>
            }

        }
    }

    @ResponseStatus(HttpStatus.OK)
    @RequestMapping(method = RequestMethod.POST, value = &quot;/plugins/register&quot;)
    public ResponseEntity&lt;JSONObject&gt; register(@Valid @RequestBody String base64) throws IOException, JSONException {
<span class="nc" id="L200">        byte[] decode = Base64.getDecoder().decode(base64);</span>
        try {
<span class="nc" id="L202">            Manifest manifest = new Manifest.ManifestBuilder().withJSON(new String(decode,&quot;UTF-8&quot;)).build();</span>

<span class="nc" id="L204">            Plugin plugin = pluginRepository.get(manifest);</span>
<span class="nc" id="L205">            ClientDetails clientDetails = pluginRepository.activate(plugin);</span>
<span class="nc" id="L206">            pluginRepository.save(plugin);</span>

<span class="nc" id="L208">            JSONObject result = new JSONObject();</span>
<span class="nc" id="L209">            result.put(&quot;client_id&quot;,clientDetails.getClientId());</span>
<span class="nc" id="L210">            result.put(&quot;client_secret&quot;,clientDetails.getClientSecret());</span>

<span class="nc" id="L212">            return new ResponseEntity(result, HttpStatus.OK);</span>
<span class="nc" id="L213">        } catch (InvalidManifestException e) {</span>
<span class="nc" id="L214">            return new ResponseEntity&lt;&gt;(HttpStatus.BAD_REQUEST);</span>
<span class="nc" id="L215">        } catch (PluginActivationException e) {</span>
<span class="nc" id="L216">            return new ResponseEntity&lt;&gt;(HttpStatus.BAD_REQUEST);</span>
<span class="nc" id="L217">        } catch (RequirementManifestException e) {</span>
<span class="nc" id="L218">            return new ResponseEntity&lt;&gt;(HttpStatus.BAD_REQUEST);</span>
        }
    }

    @ResponseStatus(HttpStatus.OK)
    @RequestMapping(method = RequestMethod.POST, value = &quot;/plugins/install&quot;)
    public ResponseEntity&lt;Void&gt; install(@RequestBody JSONObject object) throws IOException, JSONException {
<span class="nc" id="L225">        File zip = File.createTempFile(&quot;pia-plugin&quot;, &quot;zip&quot;);</span>
<span class="nc" id="L226">        Store store = storeRepository.findOne(object.getLong(&quot;id&quot;));</span>
<span class="nc" id="L227">        FileUtils.copyURLToFile(new URL(store.getUrl()+&quot;/api/plugins/&quot;+object.getLong(&quot;plugin&quot;)+&quot;/download&quot;),zip);</span>

<span class="nc" id="L229">        install(new ZipFile(zip));</span>
<span class="nc" id="L230">        return ResponseEntity.ok().build();</span>
    }

    @ResponseStatus(HttpStatus.OK)
    @RequestMapping(method = RequestMethod.POST, value = &quot;/plugins/upload&quot;)
    public void upload(@RequestPart(&quot;name&quot;) String name, @RequestPart(&quot;file&quot;) MultipartFile file) throws IOException, JSONException {
<span class="nc" id="L236">        install(Files.toZipFile(file));</span>
<span class="nc" id="L237">    }</span>

    private void install(ZipFile file) throws IOException {
        try {
<span class="nc" id="L241">            Plugin plugin = pluginRepository.install(file);</span>
<span class="nc" id="L242">            pluginRepository.activate(plugin);</span>
<span class="nc" id="L243">            pluginRepository.save(plugin);</span>
<span class="nc" id="L244">        } catch (ManifestNotFoundException e) {</span>
<span class="nc" id="L245">            e.printStackTrace();</span>
<span class="nc" id="L246">        } catch (PluginAlreadyInstalledException e) {</span>
<span class="nc" id="L247">            e.printStackTrace();</span>
<span class="nc" id="L248">        } catch (InvalidManifestException invalidManifestException) {</span>
<span class="nc" id="L249">            invalidManifestException.printStackTrace();</span>
<span class="nc" id="L250">        } catch (PluginInstallationException e) {</span>
<span class="nc" id="L251">            e.printStackTrace();</span>
<span class="nc" id="L252">        } catch (PluginActivationException e) {</span>
<span class="nc" id="L253">            e.printStackTrace();</span>
<span class="nc" id="L254">        }</span>
<span class="nc" id="L255">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>