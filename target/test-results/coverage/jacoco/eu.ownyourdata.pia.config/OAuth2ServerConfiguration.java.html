<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>OAuth2ServerConfiguration.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pia</a> &gt; <a href="index.source.html" class="el_package">eu.ownyourdata.pia.config</a> &gt; <span class="el_source">OAuth2ServerConfiguration.java</span></div><h1>OAuth2ServerConfiguration.java</h1><pre class="source lang-java linenums">package eu.ownyourdata.pia.config;

import eu.ownyourdata.pia.security.AjaxLogoutSuccessHandler;
import eu.ownyourdata.pia.security.AuthoritiesConstants;
import eu.ownyourdata.pia.security.Http401UnauthorizedEntryPoint;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Lazy;
import org.springframework.http.HttpMethod;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.core.authority.AuthorityUtils;
import org.springframework.security.oauth2.config.annotation.builders.ClientDetailsServiceBuilder;
import org.springframework.security.oauth2.config.annotation.builders.JdbcClientDetailsServiceBuilder;
import org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;
import org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;
import org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;
import org.springframework.security.oauth2.config.annotation.web.configuration.EnableResourceServer;
import org.springframework.security.oauth2.config.annotation.web.configuration.ResourceServerConfigurerAdapter;
import org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;
import org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer;
import org.springframework.security.oauth2.config.annotation.web.configurers.ResourceServerSecurityConfigurer;
import org.springframework.security.oauth2.provider.ClientAlreadyExistsException;
import org.springframework.security.oauth2.provider.ClientDetailsService;
import org.springframework.security.oauth2.provider.client.BaseClientDetails;
import org.springframework.security.oauth2.provider.client.JdbcClientDetailsService;
import org.springframework.security.oauth2.provider.token.TokenStore;
import org.springframework.security.oauth2.provider.token.store.JdbcTokenStore;

import javax.inject.Inject;
import javax.sql.DataSource;
import java.util.Arrays;

@Configuration
<span class="fc" id="L36">public class OAuth2ServerConfiguration {</span>

    @Configuration
    @EnableResourceServer
<span class="fc" id="L40">    protected static class ResourceServerConfiguration extends ResourceServerConfigurerAdapter {</span>

        @Inject
        private Http401UnauthorizedEntryPoint authenticationEntryPoint;

        @Inject
        private AjaxLogoutSuccessHandler ajaxLogoutSuccessHandler;

        @Override
        public void configure(HttpSecurity http) throws Exception {
<span class="fc" id="L50">            http</span>
<span class="fc" id="L51">                .exceptionHandling()</span>
<span class="fc" id="L52">                .authenticationEntryPoint(authenticationEntryPoint)</span>
<span class="fc" id="L53">            .and()</span>
<span class="fc" id="L54">                .logout()</span>
<span class="fc" id="L55">                .logoutUrl(&quot;/api/logout&quot;)</span>
<span class="fc" id="L56">                .logoutSuccessHandler(ajaxLogoutSuccessHandler)</span>
<span class="fc" id="L57">            .and()</span>
<span class="fc" id="L58">                .csrf()</span>
<span class="fc" id="L59">                .disable()</span>
<span class="fc" id="L60">                .headers()</span>
<span class="fc" id="L61">                .frameOptions().disable()</span>
<span class="fc" id="L62">            .and()</span>
<span class="fc" id="L63">                .authorizeRequests()</span>
<span class="fc" id="L64">                .antMatchers(HttpMethod.OPTIONS, &quot;/**&quot;).permitAll()</span>
<span class="fc" id="L65">                .antMatchers(&quot;/api/authenticate&quot;).permitAll()</span>
<span class="fc" id="L66">                .antMatchers(&quot;/api/register&quot;).permitAll()</span>
<span class="fc" id="L67">                .antMatchers(&quot;/api/logs/**&quot;).hasAnyAuthority(AuthoritiesConstants.ADMIN)</span>
<span class="fc" id="L68">                .antMatchers(&quot;/api/**&quot;).authenticated()</span>
<span class="fc" id="L69">                .antMatchers(&quot;/websocket/tracker&quot;).hasAuthority(AuthoritiesConstants.ADMIN)</span>
<span class="fc" id="L70">                .antMatchers(&quot;/websocket/**&quot;).permitAll()</span>
<span class="fc" id="L71">                .antMatchers(&quot;/metrics/**&quot;).hasAuthority(AuthoritiesConstants.ADMIN)</span>
<span class="fc" id="L72">                .antMatchers(&quot;/health/**&quot;).hasAuthority(AuthoritiesConstants.ADMIN)</span>
<span class="fc" id="L73">                .antMatchers(&quot;/trace/**&quot;).hasAuthority(AuthoritiesConstants.ADMIN)</span>
<span class="fc" id="L74">                .antMatchers(&quot;/dump/**&quot;).hasAuthority(AuthoritiesConstants.ADMIN)</span>
<span class="fc" id="L75">                .antMatchers(&quot;/shutdown/**&quot;).hasAuthority(AuthoritiesConstants.ADMIN)</span>
<span class="fc" id="L76">                .antMatchers(&quot;/beans/**&quot;).hasAuthority(AuthoritiesConstants.ADMIN)</span>
<span class="fc" id="L77">                .antMatchers(&quot;/configprops/**&quot;).hasAuthority(AuthoritiesConstants.ADMIN)</span>
<span class="fc" id="L78">                .antMatchers(&quot;/info/**&quot;).hasAuthority(AuthoritiesConstants.ADMIN)</span>
<span class="fc" id="L79">                .antMatchers(&quot;/autoconfig/**&quot;).hasAuthority(AuthoritiesConstants.ADMIN)</span>
<span class="fc" id="L80">                .antMatchers(&quot;/env/**&quot;).hasAuthority(AuthoritiesConstants.ADMIN)</span>
<span class="fc" id="L81">                .antMatchers(&quot;/trace/**&quot;).hasAuthority(AuthoritiesConstants.ADMIN)</span>
<span class="fc" id="L82">                .antMatchers(&quot;/liquibase/**&quot;).hasAuthority(AuthoritiesConstants.ADMIN)</span>
<span class="fc" id="L83">                .antMatchers(&quot;/api-docs/**&quot;).hasAuthority(AuthoritiesConstants.ADMIN)</span>
<span class="fc" id="L84">                .antMatchers(&quot;/protected/**&quot;).authenticated();</span>

<span class="fc" id="L86">        }</span>

        @Override
        public void configure(ResourceServerSecurityConfigurer resources) throws Exception {

<span class="fc" id="L91">        }</span>
    }

    @Configuration
    @EnableAuthorizationServer
<span class="fc" id="L96">    protected static class AuthorizationServerConfiguration extends AuthorizationServerConfigurerAdapter {</span>

        @Inject
        private DataSource dataSource;

        @Inject
        private JHipsterProperties jHipsterProperties;

        @Bean
        public TokenStore tokenStore() {
<span class="fc" id="L106">            return new JdbcTokenStore(dataSource);</span>
        }


        @Bean
        public JdbcClientDetailsService jdbcClientDetailsService() throws Exception {
<span class="fc" id="L112">            BaseClientDetails baseClientDetails = new BaseClientDetails();</span>
<span class="fc" id="L113">            baseClientDetails.setClientId(jHipsterProperties.getSecurity().getAuthentication().getOauth().getClientid());</span>
<span class="fc" id="L114">            baseClientDetails.setScope(Arrays.asList(&quot;read&quot;,&quot;write&quot;));</span>
<span class="fc" id="L115">            baseClientDetails.setAuthorities(AuthorityUtils.createAuthorityList(AuthoritiesConstants.ADMIN, AuthoritiesConstants.USER));</span>
<span class="fc" id="L116">            baseClientDetails.setAuthorizedGrantTypes(Arrays.asList(&quot;password&quot;, &quot;refresh_token&quot;, &quot;authorization_code&quot;, &quot;implicit&quot;));</span>
<span class="fc" id="L117">            baseClientDetails.setClientSecret(jHipsterProperties.getSecurity().getAuthentication().getOauth().getSecret());</span>
<span class="fc" id="L118">            baseClientDetails.setAccessTokenValiditySeconds(jHipsterProperties.getSecurity().getAuthentication().getOauth().getTokenValidityInSeconds());</span>


<span class="fc" id="L121">            JdbcClientDetailsService jdbcClientDetailsService = new JdbcClientDetailsService(dataSource);</span>
            try {
<span class="fc" id="L123">                jdbcClientDetailsService.addClientDetails(baseClientDetails);</span>
<span class="nc" id="L124">            } catch(ClientAlreadyExistsException e) {</span>
                //ignore
<span class="fc" id="L126">            }</span>
<span class="fc" id="L127">            return jdbcClientDetailsService;</span>
        }

        @Inject
        @Qualifier(&quot;authenticationManagerBean&quot;)
        private AuthenticationManager authenticationManager;

        @Override
        public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception {

<span class="fc" id="L137">            endpoints</span>
<span class="fc" id="L138">                .tokenStore(tokenStore())</span>
<span class="fc" id="L139">                .authenticationManager(authenticationManager);</span>
<span class="fc" id="L140">        }</span>

        @Override
        public void configure(AuthorizationServerSecurityConfigurer oauthServer) throws Exception {
<span class="fc" id="L144">            oauthServer.allowFormAuthenticationForClients();</span>
<span class="fc" id="L145">        }</span>

        @Override
        public void configure(ClientDetailsServiceConfigurer clients) throws Exception {
<span class="fc" id="L149">           clients.withClientDetails(jdbcClientDetailsService());</span>
<span class="fc" id="L150">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>